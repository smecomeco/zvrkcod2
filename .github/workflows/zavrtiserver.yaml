name: Setup Call of Duty 2 Server with GUI Access
on:
  workflow_dispatch:
jobs:
  build:
    name: Install and Run Call of Duty 2 Server
    runs-on: ubuntu-20.04
    timeout-minutes: 9999
    steps:
      - name: Update and Install Dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y curl wget tar bzip2 gzip tmux lib32gcc-s1 libstdc++6 libstdc++6:i386 lib32z1 lib32ncurses6

      - name: Create cod2server User
        run: |
          sudo adduser --disabled-password --gecos "" cod2server
          echo "cod2server ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/cod2server

      - name: Switch to cod2server User and Download LinuxGSM
        run: |
          sudo su - cod2server -c "curl -Lo linuxgsm.sh https://linuxgsm.sh && chmod +x linuxgsm.sh"
          sudo su - cod2server -c "./linuxgsm.sh cod2server"

      - name: Install Call of Duty 2 Server
        run: |
          sudo su - cod2server -c "./cod2server auto-install"

      - name: Start Call of Duty 2 Server
        run: |
          sudo su - cod2server -c "./cod2server start"

      - name: Monitor Call of Duty 2 Server
        run: |
          sudo su - cod2server -c "./cod2server monitor"

      - name: Install VNC server
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y tightvncserver xfce4 xfce4-goodies

      - name: Set VNC password
        run: |
          mkdir -p ~/.vnc
          echo "lozinka" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Start VNC server
        run: |
          vncserver :1 -geometry 1280x800 -depth 24

      - name: Install noVNC
        run: |
          sudo apt-get install -y novnc

      - name: Start noVNC
        run: |
          /usr/share/novnc/utils/launch.sh --vnc localhost:5901 --listen 8080 &

      - name: Install ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null && echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list && sudo apt update && sudo apt install ngrok

      - name: Write ngrok auth token file
        run: |
          mkdir -p ~/.ngrok2
          echo ${{ secrets.NGROK_AUTH_TOKEN }} > ~/.ngrok2/ngrok.yml

      - name: Authenticate ngrok
        run: ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Start ngrok
        run: |
          ngrok http 8080 --log=stdout > ngrok.log &
          sleep 5
          echo "Access the Ubuntu desktop via this URL:"
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
          cat ngrok.log

      - name: Keep alive
        run: |
          while true; do
            echo "Keeping the workflow alive. Access the URL above to connect."
            sleep 300
          done